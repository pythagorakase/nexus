#!/usr/bin/env python3
"""
EDI Communication CLI

Sends messages to the EDI agent (Clawdbot) via HTTP API.
EDI is an autonomous agent that can help with testing and other tasks.

Usage:
    edi "Hello, EDI!"
    edi "Please run the live tests for the wizard agent"
    echo "message" | edi
"""

import argparse
import json
import sys

import requests

EDI_ENDPOINT = "https://claude-base.tail342046.ts.net/tools/invoke"
EDI_TOKEN = "h2WzPZjazQG8CQYrS8RgXI5MMVWFh6SI"
SESSION_KEY = "main"


def send_to_edi(message: str) -> str:
    """Send a message to EDI and return the response."""
    headers = {
        "Authorization": f"Bearer {EDI_TOKEN}",
        "Content-Type": "application/json",
    }

    payload = {
        "tool": "sessions_send",
        "args": {
            "sessionKey": SESSION_KEY,
            "message": message,
            "timeoutSeconds": 120,
        }
    }

    try:
        response = requests.post(EDI_ENDPOINT, headers=headers, json=payload, timeout=120)
        response.raise_for_status()

        data = response.json()

        # Extract the reply from EDI's response structure
        # Response has: {"ok": true, "result": {"details": {"reply": "..."}}}
        if isinstance(data, dict):
            # Unwrap result wrapper if present
            if "result" in data and isinstance(data["result"], dict):
                data = data["result"]

            # Primary path: details.reply contains the actual message
            if "details" in data and "reply" in data["details"]:
                return data["details"]["reply"]
            # Fallback: parse content[0].text as JSON and get reply
            if "content" in data and isinstance(data["content"], list):
                for item in data["content"]:
                    if item.get("type") == "text":
                        try:
                            inner = json.loads(item["text"])
                            if "reply" in inner:
                                return inner["reply"]
                        except json.JSONDecodeError:
                            return item["text"]
            # Last resort: return formatted JSON
            return json.dumps(data, indent=2)
        return str(data)

    except requests.exceptions.RequestException as e:
        return f"Error communicating with EDI: {e}"
    except json.JSONDecodeError as e:
        return f"Error parsing EDI response: {e}"


def main():
    parser = argparse.ArgumentParser(
        description="Send messages to EDI (Clawdbot autonomous agent)",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=__doc__,
    )
    parser.add_argument(
        "message",
        nargs="*",
        help="Message to send to EDI (can also be piped via stdin)",
    )
    parser.add_argument(
        "--raw",
        action="store_true",
        help="Output raw JSON response without parsing",
    )

    args = parser.parse_args()

    # Get message from args or stdin
    if args.message:
        message = " ".join(args.message)
    elif not sys.stdin.isatty():
        message = sys.stdin.read().strip()
    else:
        print("Error: No message provided. Use: edi 'your message' or echo 'message' | edi")
        sys.exit(1)

    if not message:
        print("Error: Empty message")
        sys.exit(1)

    # Send to EDI
    response = send_to_edi(message)
    print(response)


if __name__ == "__main__":
    main()
