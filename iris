#!/usr/bin/env bash
#
# IRIS - Integrated Runtime for Interactive Stories
#
# Clears occupied ports, then runs honcho for proper process management
# with color-coded output and better lifecycle handling.
#

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
UI_DIR="$ROOT_DIR/ui"

if [ ! -d "$UI_DIR" ]; then
  echo "iris: expected directory '$UI_DIR' but it does not exist" >&2
  exit 1
fi

cd "$ROOT_DIR"

# Install UI dependencies if needed (first run)
if [ ! -d "$UI_DIR/node_modules" ]; then
  echo "Installing UI dependencies (first run)..."
  npm --prefix "$UI_DIR" install
fi

# Kill any existing processes on our ports to prevent EADDRINUSE errors
PORTS=(5001 8000 8001 8002 5102)
echo "Clearing ports: ${PORTS[*]}..." >&2
for port in "${PORTS[@]}"; do
  lsof -ti:"$port" | xargs kill -9 2>/dev/null || true
done
sleep 0.5  # Brief pause to ensure ports are fully released

# Run honcho for proper process management (color-coded output, better signals)
echo "Starting NEXUS services..."
exec poetry run honcho start -f Procfile.dev
